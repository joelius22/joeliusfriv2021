var beepbox;!function(t){var s=function(){function t(t,s){this._bits=[],this._readIndex=0;for(var e=0;e<s.length;e++){var i=t[s.charAt(e)];this._bits.push(0!=(32&i)),this._bits.push(0!=(16&i)),this._bits.push(0!=(8&i)),this._bits.push(0!=(4&i)),this._bits.push(0!=(2&i)),this._bits.push(0!=(1&i))}}return t.prototype.read=function(t){for(var s=0;t>0;)s<<=1,s+=this._bits[this._readIndex++]?1:0,t--;return s},t.prototype.readLongTail=function(t,s){for(var e=t,i=s;this._bits[this._readIndex++];)e+=1<<i,i++;for(;i>0;)i--,this._bits[this._readIndex++]&&(e+=1<<i);return e},t.prototype.readPartDuration=function(){return this.readLongTail(1,2)},t.prototype.readPinCount=function(){return this.readLongTail(1,0)},t.prototype.readNoteInterval=function(){return this.read(1)?-this.readLongTail(1,3):this.readLongTail(1,3)},t}(),e=function(){function t(){this._bits=[]}return t.prototype.write=function(t,s){for(t--;t>=0;)this._bits.push(1==(s>>t&1)),t--},t.prototype.writeLongTail=function(t,s,e){if(e<t)throw new Error("value out of bounds");e-=t;for(var i=s;e>=1<<i;)this._bits.push(!0),e-=1<<i,i++;for(this._bits.push(!1);i>0;)i--,this._bits.push(0!=(e&1<<i))},t.prototype.writePartDuration=function(t){this.writeLongTail(1,2,t)},t.prototype.writePinCount=function(t){this.writeLongTail(1,0,t)},t.prototype.writeNoteInterval=function(t){t<0?(this.write(1,1),this.writeLongTail(1,3,-t)):(this.write(1,0),this.writeLongTail(1,3,t))},t.prototype.concat=function(t){this._bits=this._bits.concat(t._bits)},t.prototype.encodeBase64=function(t){for(var s="",e=0;e<this._bits.length;e+=6){var i=0;this._bits[e+0]&&(i+=32),this._bits[e+1]&&(i+=16),this._bits[e+2]&&(i+=8),this._bits[e+3]&&(i+=4),this._bits[e+4]&&(i+=2),this._bits[e+5]&&(i+=1),s+=t[i]}return s},t}(),i=function(){return function(){}}();i.scaleNames=["easy :)","easy :(","island :)","island :(","blues :)","blues :(","normal :)","normal :(","romani :)","romani :(","enigma","expert"],i.scaleFlags=[[!0,!1,!0,!1,!0,!1,!1,!0,!1,!0,!1,!1],[!0,!1,!1,!0,!1,!0,!1,!0,!1,!1,!0,!1],[!0,!1,!1,!1,!0,!0,!1,!0,!1,!1,!1,!0],[!0,!0,!1,!0,!1,!1,!1,!0,!0,!1,!1,!1],[!0,!1,!0,!0,!0,!1,!1,!0,!1,!0,!1,!1],[!0,!1,!1,!0,!1,!0,!0,!0,!1,!1,!0,!1],[!0,!1,!0,!1,!0,!0,!1,!0,!1,!0,!1,!0],[!0,!1,!0,!0,!1,!0,!1,!0,!0,!1,!0,!1],[!0,!0,!1,!1,!0,!0,!1,!0,!0,!1,!0,!1],[!0,!1,!0,!0,!1,!1,!0,!0,!0,!1,!1,!0],[!0,!1,!0,!1,!0,!1,!0,!1,!0,!1,!0,!1],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0]],i.pianoScaleFlags=[!0,!1,!0,!1,!0,!0,!1,!0,!1,!0,!1,!0],i.blackKeyNameParents=[-1,1,-1,1,-1,1,-1,-1,1,-1,1,-1],i.noteNames=["C",null,"D",null,"E","F",null,"G",null,"A",null,"B"],i.keyNames=["B","A♯","A","G♯","G","F♯","F","E","D♯","D","C♯","C"],i.keyTransposes=[23,22,21,20,19,18,17,16,15,14,13,12],i.tempoNames=["molasses","slow","leisurely","moderate","steady","brisk","hasty","fast","strenuous","grueling","hyper","ludicrous"],i.reverbRange=4,i.beatsMin=3,i.beatsMax=15,i.barsMin=1,i.barsMax=128,i.patternsMin=1,i.patternsMax=64,i.instrumentsMin=1,i.instrumentsMax=10,i.partNames=["triples","standard"],i.partCounts=[3,4],i.waveNames=["triangle","square","pulse wide","pulse narrow","sawtooth","double saw","double pulse","spiky","plateau"],i.waveVolumes=[1,.5,.5,.5,.65,.5,.4,.4,.94],i.drumNames=["retro","white"],i.drumVolumes=[.25,1],i.filterNames=["sustain sharp","sustain medium","sustain soft","decay sharp","decay medium","decay soft"],i.filterBases=[2,3.5,5,1,2.5,4],i.filterDecays=[0,0,0,10,7,4],i.filterVolumes=[.4,.7,1,.5,.75,1],i.attackNames=["binary","sudden","smooth","slide"],i.effectNames=["none","vibrato light","vibrato delayed","vibrato heavy","tremelo light","tremelo heavy"],i.effectVibratos=[0,.15,.3,.45,0,0],i.effectTremelos=[0,0,0,0,.25,.5],i.chorusNames=["union","shimmer","hum","honky tonk","dissonant","fifths","octaves","bowed"],i.chorusValues=[0,.02,.05,.1,.25,3.5,6,.02],i.chorusOffsets=[0,0,0,0,0,3.5,6,0],i.chorusVolumes=[.7,.8,1,1,.9,.9,.8,1],i.volumeNames=["loudest","loud","medium","quiet","quietest","mute"],i.volumeValues=[0,.5,1,1.5,2,-1],i.channelVolumes=[.27,.27,.27,.19],i.drumInterval=6,i.numChannels=4,i.drumCount=12,i.noteCount=37,i.maxPitch=84,t.Music=i;var n=function(){return function(t,s,e){this.interval=t,this.time=s,this.volume=e}}();t.TonePin=n;var r=function(){return function(t,s,e,i,r){void 0===r&&(r=!1),this.notes=[t],this.pins=[new n(0,0,i),new n(0,e-s,r?0:i)],this.start=s,this.end=e}}();t.Tone=r;var a=function(){function t(){this.tones=[],this.instrument=0}return t.prototype.cloneTones=function(){for(var t=[],s=0,e=this.tones;s<e.length;s++){var i=e[s],a=new r(-1,i.start,i.end,3);a.notes=i.notes.concat(),a.pins=[];for(var o=0,h=i.pins;o<h.length;o++){var l=h[o];a.pins.push(new n(l.interval,l.time,l.volume))}t.push(a)}return t},t}();t.BarPattern=a;var o=function(){function t(t){void 0===t&&(t=null),null!=t?this.fromString(t):this.initToDefault()}return t.prototype.initToDefault=function(){this.channelPatterns=[[new a,new a,new a,new a,new a,new a,new a,new a],[new a,new a,new a,new a,new a,new a,new a,new a],[new a,new a,new a,new a,new a,new a,new a,new a],[new a,new a,new a,new a,new a,new a,new a,new a]],this.channelBars=[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],this.channelOctaves=[3,2,1,0],this.instrumentVolumes=[[0],[0],[0],[0]],this.instrumentWaves=[[1],[1],[1],[1]],this.instrumentFilters=[[0],[0],[0],[0]],this.instrumentAttacks=[[1],[1],[1],[1]],this.instrumentEffects=[[0],[0],[0],[0]],this.instrumentChorus=[[0],[0],[0],[0]],this.scale=0,this.key=i.keyNames.length-1,this.loopStart=0,this.loopLength=4,this.tempo=7,this.reverb=0,this.beats=8,this.bars=16,this.patterns=8,this.parts=4,this.instruments=1},t.prototype.toString=function(){var s,n,r="",a=t._base64IntToChar;for(r+=a[t._latestVersion],r+="s"+a[this.scale],r+="k"+a[this.key],r+="l"+a[this.loopStart>>6]+a[63&this.loopStart],r+="e"+a[this.loopLength-1>>6]+a[this.loopLength-1&63],r+="t"+a[this.tempo],r+="m"+a[this.reverb],r+="a"+a[this.beats-1],r+="g"+a[this.bars-1>>6]+a[this.bars-1&63],r+="j"+a[this.patterns-1],r+="i"+a[this.instruments-1],r+="r"+a[i.partCounts.indexOf(this.parts)],r+="w",s=0;s<i.numChannels;s++)for(c=0;c<this.instruments;c++)r+=a[this.instrumentWaves[s][c]];for(r+="f",s=0;s<i.numChannels;s++)for(c=0;c<this.instruments;c++)r+=a[this.instrumentFilters[s][c]];for(r+="d",s=0;s<i.numChannels;s++)for(c=0;c<this.instruments;c++)r+=a[this.instrumentAttacks[s][c]];for(r+="c",s=0;s<i.numChannels;s++)for(c=0;c<this.instruments;c++)r+=a[this.instrumentEffects[s][c]];for(r+="h",s=0;s<i.numChannels;s++)for(c=0;c<this.instruments;c++)r+=a[this.instrumentChorus[s][c]];for(r+="v",s=0;s<i.numChannels;s++)for(c=0;c<this.instruments;c++)r+=a[this.instrumentVolumes[s][c]];for(r+="o",s=0;s<i.numChannels;s++)r+=a[this.channelOctaves[s]];r+="b",n=new e;for(var o=0;1<<o<this.patterns+1;)o++;for(s=0;s<i.numChannels;s++)for(c=0;c<this.bars;c++)n.write(o,this.channelBars[s][c]);r+=n.encodeBase64(a),r+="p",n=new e;for(var h=0;1<<h<this.instruments;)h++;for(s=0;s<i.numChannels;s++){for(var l=3==s?0:12*this.channelOctaves[s],u=(3==s?4:12)+l,m=3==s?[4,6,7,2,3,8,0,10]:[12,19,24,31,36,7,0],p=[],c=0;c<m.length;c++)m[c]+=l;for(var f=0,g=this.channelPatterns[s];f<g.length;f++){var d=g[f];if(n.write(h,d.instrument),d.tones.length>0){n.write(1,1);for(var _=0,v=0,b=d.tones;v<b.length;v++){var w=b[v];w.start>_&&(n.write(2,0),n.writePartDuration(w.start-_));for(var y=new e,c=1;c<w.notes.length;c++)y.write(1,1);w.notes.length<4&&y.write(1,0),y.writePinCount(w.pins.length-1),y.write(2,w.pins[0].volume);for(var P=0,C=w.notes[0],S=C,A=[],c=1;c<w.pins.length;c++){var M=w.pins[c],B=C+M.interval;S!=B?(y.write(1,1),A.push(B),S=B):y.write(1,0),y.writePartDuration(M.time-P),P=M.time,y.write(2,M.volume)}var k=y.encodeBase64(a),N=p.indexOf(k);-1==N?(n.write(2,1),n.concat(y)):(n.write(1,1),n.writeLongTail(0,0,N),p.splice(N,1)),p.unshift(k),p.length>10&&p.pop();for(var x=w.notes.concat(A),c=0;c<x.length;c++){var V=x[c],F=m.indexOf(V);if(-1==F){var O=0,I=u;if(I<V)for(;I!=V;)I++,-1==m.indexOf(I)&&O++;else for(;I!=V;)I--,-1==m.indexOf(I)&&O--;n.write(1,0),n.writeNoteInterval(O)}else n.write(1,1),n.write(3,F),m.splice(F,1);m.unshift(V),m.length>8&&m.pop(),u=c==w.notes.length-1?w.notes[0]:V}_=w.end}_<this.beats*this.parts&&(n.write(2,0),n.writePartDuration(this.beats*this.parts-_))}else n.write(1,0)}}for(var L=n.encodeBase64(a),T=L.length,W="";T>0;)W=a[63&T]+W,T>>=6;return r+=a[W.length],r+=W,r+=L},t.prototype.fromString=function(e){if("#"==(e=e.trim()).charAt(0)&&(e=e.substring(1)),null!=e&&0!=e.length)if("{"!=e.charAt(0)){this.initToDefault();var o=0,h=t._base64CharToInt[e.charAt(o++)];if(!(-1==h||h>t._latestVersion||h<t._oldestVersion)){var l=h<3,u=h<4,m=h<5,p=t._base64CharToInt;for(l&&(this.instrumentAttacks=[[0],[0],[0],[0]]),l&&(this.instrumentWaves=[[1],[1],[1],[0]]);o<e.length;){var c=e.charAt(o++),f=void 0;if("s"==c)this.scale=p[e.charAt(o++)],l&&10==this.scale&&(this.scale=11);else if("k"==c)this.key=p[e.charAt(o++)];else if("l"==c)this.loopStart=m?p[e.charAt(o++)]:(p[e.charAt(o++)]<<6)+p[e.charAt(o++)];else if("e"==c)this.loopLength=m?p[e.charAt(o++)]:(p[e.charAt(o++)]<<6)+p[e.charAt(o++)]+1;else if("t"==c)this.tempo=u?[1,4,7,10][p[e.charAt(o++)]]:p[e.charAt(o++)],this.tempo=this._clip(0,i.tempoNames.length,this.tempo);else if("m"==c)this.reverb=p[e.charAt(o++)],this.reverb=this._clip(0,i.reverbRange,this.reverb);else if("a"==c)this.beats=l?[6,7,8,9,10][p[e.charAt(o++)]]:p[e.charAt(o++)]+1,this.beats=Math.max(i.beatsMin,Math.min(i.beatsMax,this.beats));else if("g"==c)this.bars=(p[e.charAt(o++)]<<6)+p[e.charAt(o++)]+1,this.bars=Math.max(i.barsMin,Math.min(i.barsMax,this.bars));else if("j"==c)this.patterns=p[e.charAt(o++)]+1,this.patterns=Math.max(i.patternsMin,Math.min(i.patternsMax,this.patterns));else if("i"==c)this.instruments=p[e.charAt(o++)]+1,this.instruments=Math.max(i.instrumentsMin,Math.min(i.instrumentsMax,this.instruments));else if("r"==c)this.parts=i.partCounts[p[e.charAt(o++)]];else if("w"==c)if(l)f=p[e.charAt(o++)],this.instrumentWaves[f][0]=this._clip(0,i.waveNames.length,p[e.charAt(o++)]);else for(f=0;f<i.numChannels;f++)for(v=0;v<this.instruments;v++)this.instrumentWaves[f][v]=this._clip(0,i.waveNames.length,p[e.charAt(o++)]);else if("f"==c)if(l)f=p[e.charAt(o++)],this.instrumentFilters[f][0]=[0,2,3,5][this._clip(0,i.filterNames.length,p[e.charAt(o++)])];else for(f=0;f<i.numChannels;f++)for(v=0;v<this.instruments;v++)this.instrumentFilters[f][v]=this._clip(0,i.filterNames.length,p[e.charAt(o++)]);else if("d"==c)if(l)f=p[e.charAt(o++)],this.instrumentAttacks[f][0]=this._clip(0,i.attackNames.length,p[e.charAt(o++)]);else for(f=0;f<i.numChannels;f++)for(v=0;v<this.instruments;v++)this.instrumentAttacks[f][v]=this._clip(0,i.attackNames.length,p[e.charAt(o++)]);else if("c"==c)if(l)f=p[e.charAt(o++)],this.instrumentEffects[f][0]=this._clip(0,i.effectNames.length,p[e.charAt(o++)]),1==this.instrumentEffects[f][0]?this.instrumentEffects[f][0]=3:3==this.instrumentEffects[f][0]&&(this.instrumentEffects[f][0]=5);else for(f=0;f<i.numChannels;f++)for(v=0;v<this.instruments;v++)this.instrumentEffects[f][v]=this._clip(0,i.effectNames.length,p[e.charAt(o++)]);else if("h"==c)if(l)f=p[e.charAt(o++)],this.instrumentChorus[f][0]=this._clip(0,i.chorusNames.length,p[e.charAt(o++)]);else for(f=0;f<i.numChannels;f++)for(v=0;v<this.instruments;v++)this.instrumentChorus[f][v]=this._clip(0,i.chorusNames.length,p[e.charAt(o++)]);else if("v"==c)if(l)f=p[e.charAt(o++)],this.instrumentVolumes[f][0]=this._clip(0,i.volumeNames.length,p[e.charAt(o++)]);else for(f=0;f<i.numChannels;f++)for(v=0;v<this.instruments;v++)this.instrumentVolumes[f][v]=this._clip(0,i.volumeNames.length,p[e.charAt(o++)]);else if("o"==c)if(l)f=p[e.charAt(o++)],this.channelOctaves[f]=this._clip(0,5,p[e.charAt(o++)]);else for(f=0;f<i.numChannels;f++)this.channelOctaves[f]=this._clip(0,5,p[e.charAt(o++)]);else if("b"==c){var g=void 0;if(l){f=p[e.charAt(o++)];var d=p[e.charAt(o++)];g=Math.ceil(.5*d);for(var _=new s(p,e.substr(o,g)),v=0;v<d;v++)this.channelBars[f][v]=_.read(3)+1}else if(m){for(var b=0;1<<b<this.patterns;)b++;g=Math.ceil(i.numChannels*this.bars*b/6);_=new s(p,e.substr(o,g));for(f=0;f<i.numChannels;f++){this.channelBars[f].length=this.bars;for(v=0;v<this.bars;v++)this.channelBars[f][v]=_.read(b)+1}}else{for(var w=0;1<<w<this.patterns+1;)w++;g=Math.ceil(i.numChannels*this.bars*w/6);_=new s(p,e.substr(o,g));for(f=0;f<i.numChannels;f++){this.channelBars[f].length=this.bars;for(v=0;v<this.bars;v++)this.channelBars[f][v]=_.read(w)}}o+=g}else if("p"==c){var y=0;if(l)f=p[e.charAt(o++)],o++,y=p[e.charAt(o++)],y<<=6,y+=p[e.charAt(o++)];else{f=0;for(var P=p[e.charAt(o++)];P>0;)y<<=6,y+=p[e.charAt(o++)],P--}_=new s(p,e.substr(o,y));o+=y;for(var C=0;1<<C<this.instruments;)C++;for(;;){this.channelPatterns[f]=[];for(var S=3==f?0:12*this.channelOctaves[f],A=null,M=null,B=(3==f?4:12)+S,k=3==f?[4,6,7,2,3,8,0,10]:[12,19,24,31,36,7,0],N=[],v=0;v<k.length;v++)k[v]+=S;for(v=0;v<this.patterns;v++){var x=new a;if(x.instrument=_.read(C),this.channelPatterns[f][v]=x,l||0!=_.read(1)){for(var V=0,F=[];V<this.beats*this.parts;){var O=1==_.read(1),I=!1,L=0;if(O?L=_.readLongTail(0,0):I=1==_.read(1),O||I){var T=void 0,W=void 0,D=void 0;if(O)T=N[L],N.splice(L,1);else{for((T={}).noteCount=1;T.noteCount<4&&1==_.read(1);)T.noteCount++;T.pinCount=_.readPinCount(),T.initialVolume=_.read(2),T.pins=[],T.length=0,T.bendCount=0;for(q=0;q<T.pinCount;q++)(W={}).pitchBend=1==_.read(1),W.pitchBend&&T.bendCount++,T.length+=_.readPartDuration(),W.time=T.length,W.volume=_.read(2),T.pins.push(W)}N.unshift(T),N.length>10&&N.pop(),(A=new r(0,V,V+T.length,T.initialVolume)).notes=[],A.pins.length=1;for(var E=[],q=0;q<T.noteCount+T.bendCount;q++){if(1==_.read(1)){var j=_.read(3);D=k[j],k.splice(j,1)}else{D=B;for(var G=_.readNoteInterval();G>0;){for(D++;-1!=k.indexOf(D);)D++;G--}for(;G<0;){for(D--;-1!=k.indexOf(D);)D--;G++}}k.unshift(D),k.length>8&&k.pop(),q<T.noteCount?A.notes.push(D):E.push(D),B=q==T.noteCount-1?A.notes[0]:D}E.unshift(A.notes[0]);for(var J=0,R=T.pins;J<R.length;J++){var z=R[J];z.pitchBend&&E.shift(),M=new n(E[0]-A.notes[0],z.time,z.volume),A.pins.push(M)}V=A.end,F.push(A)}else V+=_.readPartDuration()}x.tones=F}}if(l)break;if(++f>=i.numChannels)break}}}}}else this.fromJsonObject(JSON.parse(e));else this.initToDefault()},t.prototype.toJsonObject=function(s,e,n){void 0===s&&(s=!0),void 0===e&&(e=1),void 0===n&&(n=!0);for(var r=[],a=0;a<i.numChannels;a++){for(var o=[],h=0;h<this.instruments;h++)3==a?o.push({volume:20*(5-this.instrumentVolumes[a][h]),wave:i.drumNames[this.instrumentWaves[a][h]],envelope:i.attackNames[this.instrumentAttacks[a][h]]}):o.push({volume:20*(5-this.instrumentVolumes[a][h]),wave:i.waveNames[this.instrumentWaves[a][h]],envelope:i.attackNames[this.instrumentAttacks[a][h]],filter:i.filterNames[this.instrumentFilters[a][h]],chorus:i.chorusNames[this.instrumentChorus[a][h]],effect:i.effectNames[this.instrumentEffects[a][h]]});for(var l=[],u=0,m=this.channelPatterns[a];u<m.length;u++){for(var p=m[u],c=[],f=0,g=p.tones;f<g.length;f++){for(var d=g[f],_=[],v=0,b=d.pins;v<b.length;v++){var w=b[v];_.push({tick:w.time+d.start,pitchBend:w.interval,volume:Math.round(100*w.volume/3)})}c.push({pitches:d.notes,points:_})}l.push({instrument:p.instrument+1,notes:c})}var y=[];if(s)for(h=0;h<this.loopStart;h++)y.push(this.channelBars[a][h]);for(var P=0;P<e;P++)for(h=this.loopStart;h<this.loopStart+this.loopLength;h++)y.push(this.channelBars[a][h]);if(n)for(h=this.loopStart+this.loopLength;h<this.bars;h++)y.push(this.channelBars[a][h]);r.push({octaveScrollBar:this.channelOctaves[a],instruments:o,patterns:l,sequence:y})}return{version:t._latestVersion,scale:i.scaleNames[this.scale],key:i.keyNames[this.key],introBars:this.loopStart,loopBars:this.loopLength,beatsPerBar:this.beats,ticksPerBeat:this.parts,beatsPerMinute:this.getBeatsPerMinute(),reverb:this.reverb,channels:r}},t.prototype.fromJsonObject=function(t){if(this.initToDefault(),t&&5===t.version){if(this.scale=11,void 0!=t.scale){var s=i.scaleNames.indexOf(t.scale);-1!=s&&(this.scale=s)}if(void 0!=t.key)if("number"==typeof t.key)this.key=i.keyNames.length-1-(t.key+1200>>>0)%i.keyNames.length;else if("string"==typeof t.key){var e=t.key,o=e.charAt(0).toUpperCase(),h=e.charAt(1).toLowerCase(),l={"#":-1,"♯":-1,b:1,"♭":1},u={C:11,D:9,E:7,F:6,G:4,A:2,B:0}[o],m=l[h];void 0!=u&&(void 0!=m&&(u+=m),u<0&&(u+=12),u%=12,this.key=u)}if(void 0!=t.beatsPerMinute){var p=0|t.beatsPerMinute;this.tempo=Math.round(4+9*Math.log(p/120)/Math.LN2),this.tempo=this._clip(0,i.tempoNames.length,this.tempo)}void 0!=t.reverb&&(this.reverb=this._clip(0,i.reverbRange,0|t.reverb)),void 0!=t.beatsPerBar&&(this.beats=Math.max(i.beatsMin,Math.min(i.beatsMax,0|t.beatsPerBar))),void 0!=t.ticksPerBeat&&(this.parts=Math.max(3,Math.min(4,0|t.ticksPerBeat)));for(var c=1,f=1,g=1,d=0;d<i.numChannels;d++)t.channels&&t.channels[d]&&((_=t.channels[d]).instruments&&(c=Math.max(c,0|_.instruments.length)),_.patterns&&(f=Math.max(f,0|_.patterns.length)),_.sequence&&(g=Math.max(g,0|_.sequence.length)));this.instruments=c,this.patterns=f,this.bars=g,void 0!=t.introBars&&(this.loopStart=this._clip(0,this.bars,0|t.introBars)),void 0!=t.loopBars&&(this.loopLength=this._clip(1,this.bars-this.loopStart+1,0|t.loopBars));for(d=0;d<i.numChannels;d++){var _=void 0;t.channels&&(_=t.channels[d]),void 0==_&&(_={}),void 0!=_.octaveScrollBar&&(this.channelOctaves[d]=this._clip(0,5,0|_.octaveScrollBar)),this.instrumentVolumes[d].length=this.instruments,this.instrumentWaves[d].length=this.instruments,this.instrumentAttacks[d].length=this.instruments,this.instrumentFilters[d].length=this.instruments,this.instrumentChorus[d].length=this.instruments,this.instrumentEffects[d].length=this.instruments,this.channelPatterns[d].length=this.patterns,this.channelBars[d].length=this.bars;for(D=0;D<this.instruments;D++){var v=void 0;_.instruments&&(v=_.instruments[D]),void 0==v&&(v={}),void 0!=v.volume?this.instrumentVolumes[d][D]=this._clip(0,i.volumeNames.length,Math.round(5-(0|v.volume)/20)):this.instrumentVolumes[d][D]=0,this.instrumentAttacks[d][D]=i.attackNames.indexOf(v.envelope),-1==this.instrumentAttacks[d][D]&&(this.instrumentAttacks[d][D]=1),3==d?(this.instrumentWaves[d][D]=i.drumNames.indexOf(v.wave),-1==this.instrumentWaves[d][D]&&(this.instrumentWaves[d][D]=0),this.instrumentFilters[d][D]=0,this.instrumentChorus[d][D]=0,this.instrumentEffects[d][D]=0):(this.instrumentWaves[d][D]=i.waveNames.indexOf(v.wave),-1==this.instrumentWaves[d][D]&&(this.instrumentWaves[d][D]=1),this.instrumentFilters[d][D]=i.filterNames.indexOf(v.filter),-1==this.instrumentFilters[d][D]&&(this.instrumentFilters[d][D]=0),this.instrumentChorus[d][D]=i.chorusNames.indexOf(v.chorus),-1==this.instrumentChorus[d][D]&&(this.instrumentChorus[d][D]=0),this.instrumentEffects[d][D]=i.effectNames.indexOf(v.effect),-1==this.instrumentEffects[d][D]&&(this.instrumentEffects[d][D]=0))}for(D=0;D<this.patterns;D++){var b=new a;this.channelPatterns[d][D]=b;var w=void 0;if(_.patterns&&(w=_.patterns[D]),void 0!=w&&(b.instrument=this._clip(0,this.instruments,(0|w.instrument)-1),w.notes&&w.notes.length>0))for(var y=Math.min(this.beats*this.parts,w.notes.length>>>0),P=0,C=0;C<w.notes.length&&!(C>=y);C++){var S=w.notes[C];if(S&&S.pitches&&S.pitches.length>=1&&S.points&&S.points.length>=2){var A=new r(0,0,0,0);A.notes=[],A.pins=[];for(N=0;N<S.pitches.length;N++){var M=0|S.pitches[N];if(-1==A.notes.indexOf(M)&&(A.notes.push(M),A.notes.length>=4))break}if(!(A.notes.length<1)){for(var B=P,k=0,N=0;N<S.points.length;N++){var x=S.points[N];if(void 0!=x&&void 0!=x.tick){var V=void 0==x.pitchBend?0:0|x.pitchBend,F=0|x.tick,O=void 0==x.volume?3:Math.max(0,Math.min(3,Math.round(3*(0|x.volume)/100)));if(!(F>this.beats*this.parts)){if(0==A.pins.length){if(F<B)continue;A.start=F,k=V}else if(F<=B)continue;B=F,A.pins.push(new n(V-k,F-A.start,O))}}}if(!(A.pins.length<2)){A.end=A.pins[A.pins.length-1].time+A.start;for(var I=3==d?i.drumCount-1:i.maxPitch,L=I,T=0,N=0;N<A.notes.length;N++)A.notes[N]+=k,(A.notes[N]<0||A.notes[N]>I)&&(A.notes.splice(N,1),N--),A.notes[N]<L&&(L=A.notes[N]),A.notes[N]>T&&(T=A.notes[N]);if(!(A.notes.length<1)){for(N=0;N<A.pins.length;N++){var W=A.pins[N];W.interval+L<0&&(W.interval=-L),W.interval+T>I&&(W.interval=I-T),N>=2&&W.interval==A.pins[N-1].interval&&W.interval==A.pins[N-2].interval&&W.volume==A.pins[N-1].volume&&W.volume==A.pins[N-2].volume&&(A.pins.splice(N-1,1),N--)}b.tones.push(A),P=A.end}}}}}}for(var D=0;D<this.bars;D++)this.channelBars[d][D]=_.sequence?Math.min(this.patterns,_.sequence[D]>>>0):0}}},t.prototype._clip=function(t,s,e){return s-=1,e<=s?e>=t?e:t:s},t.prototype.getPattern=function(t,s){var e=this.channelBars[t][s];return 0==e?null:this.channelPatterns[t][e-1]},t.prototype.getPatternInstrument=function(t,s){var e=this.getPattern(t,s);return null==e?0:e.instrument},t.prototype.getBeatsPerMinute=function(){return Math.round(120*Math.pow(2,(-4+this.tempo)/9))},t}();o._oldestVersion=2,o._latestVersion=5,o._base64CharToInt={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,a:10,b:11,c:12,d:13,e:14,f:15,g:16,h:17,i:18,j:19,k:20,l:21,m:22,n:23,o:24,p:25,q:26,r:27,s:28,t:29,u:30,v:31,w:32,x:33,y:34,z:35,A:36,B:37,C:38,D:39,E:40,F:41,G:42,H:43,I:44,J:45,K:46,L:47,M:48,N:49,O:50,P:51,Q:52,R:53,S:54,T:55,U:56,V:57,W:58,X:59,Y:60,Z:61,"-":62,".":62,_:63},o._base64IntToChar=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","-","_"],t.Song=o;var h=function(){function t(t){void 0===t&&(t=null),this.samplesPerSecond=44100,this._effectDuration=.14,this._effectAngle=2*Math.PI/(this._effectDuration*this.samplesPerSecond),this._effectYMult=2*Math.cos(this._effectAngle),this._limitDecay=1/(2*this.samplesPerSecond),this._waves=[new Float64Array([1/15,.2,5/15,7/15,.6,11/15,13/15,1,1,13/15,11/15,.6,7/15,5/15,.2,1/15,-1/15,-.2,-5/15,-7/15,-.6,-11/15,-13/15,-1,-1,-13/15,-11/15,-.6,-7/15,-5/15,-.2,-1/15]),new Float64Array([1,-1]),new Float64Array([1,-1,-1,-1]),new Float64Array([1,-1,-1,-1,-1,-1,-1,-1]),new Float64Array([1/31,3/31,5/31,7/31,9/31,11/31,13/31,15/31,17/31,19/31,21/31,23/31,25/31,27/31,29/31,1,-1,-29/31,-27/31,-25/31,-23/31,-21/31,-19/31,-17/31,-15/31,-13/31,-11/31,-9/31,-7/31,-5/31,-3/31,-1/31]),new Float64Array([0,-.2,-.4,-.6,-.8,-1,1,-.8,-.6,-.4,-.2,1,.8,.6,.4,.2]),new Float64Array([1,1,1,1,1,-1,-1,-1,1,1,1,1,-1,-1,-1,-1]),new Float64Array([1,-1,1,-1,1,0]),new Float64Array([0,.2,.4,.5,.6,.7,.8,.85,.9,.95,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,.95,.9,.85,.8,.7,.6,.5,.4,.2,0,-.2,-.4,-.5,-.6,-.7,-.8,-.85,-.9,-.95,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-.95,-.9,-.85,-.8,-.7,-.6,-.5,-.4,-.2])],this._drumWaves=[new Float32Array(32767),new Float32Array(32767)],this.song=null,this.stutterPressed=!1,this.pianoPressed=!1,this.pianoNote=0,this.pianoChannel=0,this.enableIntro=!0,this.enableOutro=!1,this.loopCount=-1,this.volume=1,this._playhead=0,this._bar=0,this._beat=0,this._part=0,this._arpeggio=0,this._arpeggioSamples=0,this._paused=!0,this._leadPeriodA=0,this._leadPeriodB=0,this._leadSample=0,this._harmonyPeriodA=0,this._harmonyPeriodB=0,this._harmonySample=0,this._bassPeriodA=0,this._bassPeriodB=0,this._bassSample=0,this._drumPeriod=0,this._drumSample=0,this._drumSignal=1,this._stillGoing=!1,this._effectPeriod=0,this._limit=0,this._delayLine=new Float32Array(16384),this._delayPos=0,this._delayFeedback0=0,this._delayFeedback1=0,this._delayFeedback2=0,this._delayFeedback3=0;for(var s=0,e=this._waves;s<e.length;s++){for(var i=e[s],n=0,r=0;r<i.length;r++)n+=i[r];for(var a=n/i.length,r=0;r<i.length;r++)i[r]-=a}for(var o=0;o<this._drumWaves.length;o++){i=this._drumWaves[o];if(0==o)for(var h=1,r=0;r<32767;r++){i[r]=2*(1&h)-1;var l=h>>1;1==(h+l&1)&&(l+=16384),h=l}else if(1==o)for(r=0;r<32767;r++)i[r]=2*Math.random()-1}null!=t&&this.setSong(t)}return Object.defineProperty(t.prototype,"playing",{get:function(){return!this._paused},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"playhead",{get:function(){return this._playhead},set:function(t){if(null!=this.song){this._playhead=Math.max(0,Math.min(this.song.bars,t));var s=this._playhead;this._bar=Math.floor(s),s=this.song.beats*(s-this._bar),this._beat=Math.floor(s),s=this.song.parts*(s-this._beat),this._part=Math.floor(s),s=4*(s-this._part),this._arpeggio=Math.floor(s);var e=this._getSamplesPerArpeggio();s=e*(s-this._arpeggio),this._arpeggioSamples=Math.floor(e-s),this._bar<this.song.loopStart&&(this.enableIntro=!0),this._bar>this.song.loopStart+this.song.loopLength&&(this.enableOutro=!0)}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"totalSamples",{get:function(){if(null==this.song)return 0;var t=4*this._getSamplesPerArpeggio()*this.song.parts*this.song.beats,s=this.loopCount;s<0&&(s=1);var e=this.song.loopLength*s;return this.enableIntro&&(e+=this.song.loopStart),this.enableOutro&&(e+=this.song.bars-(this.song.loopStart+this.song.loopLength)),e*t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"totalSeconds",{get:function(){return this.totalSamples/this.samplesPerSecond},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"totalBars",{get:function(){return null==this.song?0:this.song.bars},enumerable:!0,configurable:!0}),t.prototype.setSong=function(t){"string"==typeof t?this.song=new o(t):t instanceof o&&(this.song=t)},t.prototype.play=function(){if(this._paused){this._paused=!1;var t=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.oAudioContext||window.msAudioContext;this._audioCtx=this._audioCtx||new t,this._scriptNode=this._audioCtx.createScriptProcessor?this._audioCtx.createScriptProcessor(2048,0,1):this._audioCtx.createJavaScriptNode(2048,0,1),this._scriptNode.onaudioprocess=this._onSampleData.bind(this),this._scriptNode.channelCountMode="explicit",this._scriptNode.channelInterpretation="speakers",this._scriptNode.connect(this._audioCtx.destination),this.samplesPerSecond=this._audioCtx.sampleRate,this._effectAngle=2*Math.PI/(this._effectDuration*this.samplesPerSecond),this._effectYMult=2*Math.cos(this._effectAngle),this._limitDecay=1/(2*this.samplesPerSecond)}},t.prototype.pause=function(){this._paused||(this._paused=!0,this._scriptNode.disconnect(this._audioCtx.destination),this._audioCtx.close&&(this._audioCtx.close(),this._audioCtx=null),this._scriptNode=null)},t.prototype.snapToStart=function(){this._bar=0,this.enableIntro=!0,this.snapToBar()},t.prototype.snapToBar=function(){this._playhead=this._bar,this._beat=0,this._part=0,this._arpeggio=0,this._arpeggioSamples=0,this._effectPeriod=0,this._leadSample=0,this._harmonySample=0,this._bassSample=0,this._drumSample=0,this._delayPos=0,this._delayFeedback0=0,this._delayFeedback1=0,this._delayFeedback2=0,this._delayFeedback3=0;for(var t=0;t<this._delayLine.length;t++)this._delayLine[t]=0},t.prototype.nextBar=function(){var t=this._bar;this._bar++,this.enableOutro?this._bar>=this.song.bars&&(this._bar=this.enableIntro?0:this.song.loopStart):(this._bar>=this.song.loopStart+this.song.loopLength||this._bar>=this.song.bars)&&(this._bar=this.song.loopStart),this._playhead+=this._bar-t},t.prototype.prevBar=function(){var t=this._bar;--this._bar<0&&(this._bar=this.song.loopStart+this.song.loopLength-1),this._bar>=this.song.bars&&(this._bar=this.song.bars-1),this._bar<this.song.loopStart&&(this.enableIntro=!0),!this.enableOutro&&this._bar>=this.song.loopStart+this.song.loopLength&&(this._bar=this.song.loopStart+this.song.loopLength-1),this._playhead+=this._bar-t},t.prototype._onSampleData=function(t){var s=t.outputBuffer,e=s.getChannelData(0);this.synthesize(e,s.length)},t.prototype.synthesize=function(t,s){var e=this;if(null!=this.song){var n,r=0;if(this.stutterPressed){var a=this._bar,o=this._beat,h=this._part,l=this._arpeggio,u=this._arpeggioSamples,m=this._leadPeriodA,p=this._leadPeriodB,c=this._leadSample,f=this._harmonyPeriodA,g=this._harmonyPeriodB,d=this._harmonySample,_=this._bassPeriodA,v=this._bassPeriodB,b=this._bassSample,w=this._drumPeriod,y=this._drumSample,P=this._drumSignal,C=this._effectPeriod,S=this._limit;n=function(){e._bar=a,e._beat=o,e._part=h,e._arpeggio=l,e._arpeggioSamples=u,e._leadPeriodA=m,e._leadPeriodB=p,e._leadSample=c,e._harmonyPeriodA=f,e._harmonyPeriodB=g,e._harmonySample=d,e._bassPeriodA=_,e._bassPeriodB=v,e._bassSample=b,e._drumPeriod=w,e._drumSample=y,e._drumSignal=P,e._effectPeriod=C,e._limit=S}}var A=1/this.samplesPerSecond,M=this._getSamplesPerArpeggio(),B=this._effectYMult,k=this._limitDecay,N=this.volume,x=this._delayLine,V=.425*Math.pow(this.song.reverb/i.reverbRange,.667),F=!1;(0==this._arpeggioSamples||this._arpeggioSamples>M)&&(this._arpeggioSamples=M),this._part>=this.song.parts&&(this._beat++,this._part=0,this._arpeggio=0,this._arpeggioSamples=M),this._beat>=this.song.beats&&(this._bar++,this._beat=0,this._part=0,this._arpeggio=0,this._arpeggioSamples=M,-1==this.loopCount&&(this._bar<this.song.loopStart&&!this.enableIntro&&(this._bar=this.song.loopStart),this._bar>=this.song.loopStart+this.song.loopLength&&!this.enableOutro&&(this._bar=this.song.loopStart))),this._bar>=this.song.bars&&(this.enableOutro?(this._bar=0,this.enableIntro=!0,F=!0,this.pause()):this._bar=this.song.loopStart),this._bar>=this.song.loopStart&&(this.enableIntro=!1);var O,I,L,T,W,D,E,q,j,G,J,R,z,Y,K,U,H,Q,X,Z,$,tt,st,et,it,nt,rt,at=function(){var t=e.song.getPatternInstrument(0,e._bar),s=e.song.getPatternInstrument(1,e._bar),n=e.song.getPatternInstrument(2,e._bar),r=e.song.getPatternInstrument(3,e._bar);O=i.channelVolumes[0]*(5==e.song.instrumentVolumes[0][t]?0:Math.pow(2,-i.volumeValues[e.song.instrumentVolumes[0][t]]))*i.waveVolumes[e.song.instrumentWaves[0][t]]*i.filterVolumes[e.song.instrumentFilters[0][t]]*i.chorusVolumes[e.song.instrumentChorus[0][t]]*.5,I=i.channelVolumes[1]*(5==e.song.instrumentVolumes[1][s]?0:Math.pow(2,-i.volumeValues[e.song.instrumentVolumes[1][s]]))*i.waveVolumes[e.song.instrumentWaves[1][s]]*i.filterVolumes[e.song.instrumentFilters[1][s]]*i.chorusVolumes[e.song.instrumentChorus[0][s]]*.5,L=i.channelVolumes[2]*(5==e.song.instrumentVolumes[2][n]?0:Math.pow(2,-i.volumeValues[e.song.instrumentVolumes[2][n]]))*i.waveVolumes[e.song.instrumentWaves[2][n]]*i.filterVolumes[e.song.instrumentFilters[2][n]]*i.chorusVolumes[e.song.instrumentChorus[0][n]]*.5,T=i.channelVolumes[3]*(5==e.song.instrumentVolumes[3][r]?0:Math.pow(2,-i.volumeValues[e.song.instrumentVolumes[3][r]]))*i.drumVolumes[e.song.instrumentWaves[3][r]],W=e._waves[e.song.instrumentWaves[0][t]],D=e._waves[e.song.instrumentWaves[1][s]],E=e._waves[e.song.instrumentWaves[2][n]],q=e._drumWaves[e.song.instrumentWaves[3][r]],j=W.length,G=D.length,J=E.length,R=Math.pow(2,-i.filterBases[e.song.instrumentFilters[0][t]]),z=Math.pow(2,-i.filterBases[e.song.instrumentFilters[1][s]]),Y=Math.pow(2,-i.filterBases[e.song.instrumentFilters[2][n]]),K=1,U=i.effectTremelos[e.song.instrumentEffects[0][t]],H=i.effectTremelos[e.song.instrumentEffects[1][s]],Q=i.effectTremelos[e.song.instrumentEffects[2][n]],X=Math.pow(2,(i.chorusOffsets[e.song.instrumentChorus[0][t]]+i.chorusValues[e.song.instrumentChorus[0][t]])/12),Z=Math.pow(2,(i.chorusOffsets[e.song.instrumentChorus[1][s]]+i.chorusValues[e.song.instrumentChorus[1][s]])/12),$=Math.pow(2,(i.chorusOffsets[e.song.instrumentChorus[2][n]]+i.chorusValues[e.song.instrumentChorus[2][n]])/12),tt=Math.pow(2,(i.chorusOffsets[e.song.instrumentChorus[0][t]]-i.chorusValues[e.song.instrumentChorus[0][t]])/12),st=Math.pow(2,(i.chorusOffsets[e.song.instrumentChorus[1][s]]-i.chorusValues[e.song.instrumentChorus[1][s]])/12),et=Math.pow(2,(i.chorusOffsets[e.song.instrumentChorus[2][n]]-i.chorusValues[e.song.instrumentChorus[2][n]])/12),it=7==e.song.instrumentChorus[0][t]?-1:1,nt=7==e.song.instrumentChorus[1][s]?-1:1,rt=7==e.song.instrumentChorus[2][n]?-1:1,0==e.song.instrumentChorus[0][t]&&(e._leadPeriodB=e._leadPeriodA),0==e.song.instrumentChorus[1][s]&&(e._harmonyPeriodB=e._harmonyPeriodA),0==e.song.instrumentChorus[2][n]&&(e._bassPeriodB=e._bassPeriodA)};for(at();s>0;){if(F){for(console.log("ended");s-- >0;)t[r]=0,r++;break}var ot=void 0;s-=ot=this._arpeggioSamples<=s?this._arpeggioSamples:s,this._arpeggioSamples-=ot;for(var ht,lt,ut,mt,pt,ct,ft,gt,dt,_t,vt,bt,wt,yt,Pt,Ct,St,At,Mt,Bt,kt,Nt,xt,Vt,Ft,Ot=this._part+this._beat*this.song.parts,It=0;It<4;It++){var Lt=this.song.getPattern(It,this._bar),Tt=null==Lt?0:this.song.instrumentAttacks[It][Lt.instrument],Wt=null,Dt=null,Et=null;if(null!=Lt)for(de=0;de<Lt.tones.length;de++)if(Lt.tones[de].end<=Ot)Dt=Lt.tones[de];else if(Lt.tones[de].start<=Ot&&Lt.tones[de].end>Ot)Wt=Lt.tones[de];else if(Lt.tones[de].start>Ot){Et=Lt.tones[de];break}null!=Wt&&null!=Dt&&Dt.end!=Wt.start&&(Dt=null),null!=Wt&&null!=Et&&Et.start!=Wt.end&&(Et=null);var qt=3==It?69:i.keyTransposes[this.song.key],jt=3==It?i.drumInterval:1,Gt=void 0,Jt=void 0,Rt=void 0,zt=void 0,Yt=void 0,Kt=void 0,Ut=void 0,Ht=!1;if(this.pianoPressed&&It==this.pianoChannel){var Qt=this._frequencyFromPitch(qt+this.pianoNote*jt),Xt=void 0;3==It?this.song.instrumentWaves[3][Lt.instrument]>0?(K=Math.min(1,Qt*A*8),Xt=24):Xt=60:Xt=48,Gt=Qt*A,Jt=1,Rt=Math.pow(2,-this.pianoNote*jt/Xt),zt=0,Yt=1,Kt=1,Ut=Math.pow(2,i.effectVibratos[this.song.instrumentEffects[It][Lt.instrument]]/12)-1}else if(null==Wt)Gt=0,Jt=0,Rt=0,zt=0,Yt=1,Kt=1,Ut=0,Ht=!0;else{var Zt=void 0;Zt=2==Wt.notes.length?Wt.notes[this._arpeggio>>1]:3==Wt.notes.length?Wt.notes[3==this._arpeggio?1:this._arpeggio]:4==Wt.notes.length?Wt.notes[this._arpeggio]:Wt.notes[0];for(var $t=null,ts=null,ss=0,es=Wt.pins;ss<es.length;ss++){var is=es[ss];if(!(is.time+Wt.start<=Ot)){ts=is;break}$t=is}var ns=4*Wt.start,rs=4*Wt.end,as=4*(Wt.start+$t.time),os=4*(Wt.start+ts.time),hs=4*Ot+this._arpeggio,ls=4*Ot+this._arpeggio+1,us=(hs-as)/(os-as),ms=(ls-as)/(os-as),ps=$t.volume*(1-us)+ts.volume*us,cs=$t.volume*(1-ms)+ts.volume*ms,fs=$t.interval*(1-us)+ts.interval*us,gs=$t.interval*(1-ms)+ts.interval*ms,ds=$t.time*(1-us)+ts.time*us,_s=$t.time*(1-ms)+ts.time*ms,vs=!1;hs==ns&&(0==Tt?vs=!0:2==Tt?ps=0:3==Tt&&(null==Dt||Dt.notes.length>1||Wt.notes.length>1?ps=0:0==Dt.pins[Dt.pins.length-1].volume||0==Wt.pins[0].volume?ps=0:(fs=.5*(Dt.notes[0]+Dt.pins[Dt.pins.length-1].interval-Zt),ds=.5*Dt.pins[Dt.pins.length-1].time,vs=!0))),ls==rs&&(1==Tt||2==Tt?cs=0:3==Tt&&(null==Et||Et.notes.length>1||Wt.notes.length>1?cs=0:0==Wt.pins[Wt.pins.length-1].volume||0==Et.pins[0].volume?ps=0:(gs=.5*(Et.notes[0]+Wt.pins[Wt.pins.length-1].interval-Zt),_s*=.5)));var bs=1-(this._arpeggioSamples+ot)/M,ws=1-this._arpeggioSamples/M,ys=fs*(1-bs)+gs*bs,Ps=fs*(1-ws)+gs*ws,Cs=ds*(1-bs)+_s*bs,Ss=ds*(1-ws)+_s*ws,As=this._frequencyFromPitch(qt+(Zt+ys)*jt),Ms=this._frequencyFromPitch(qt+(Zt+Ps)*jt),Bs=void 0;3==It?this.song.instrumentWaves[3][Lt.instrument]>0?(K=Math.min(1,As*A*8),Bs=24):Bs=60:Bs=48;var ks=Math.pow(2,-(Zt+ys)*jt/Bs),Ns=Math.pow(2,-(Zt+Ps)*jt/Bs);ks*=this._volumeConversion(ps*(1-bs)+cs*bs),Ns*=this._volumeConversion(ps*(1-ws)+cs*ws);var xs=Ms/As;Gt=As*A,Jt=Math.pow(xs,1/ot),Rt=ks,zt=(Ns-ks)/ot,0!=(hs+bs-ns)*M/this.samplesPerSecond||vs||(Ht=!0);var Vs=i.filterDecays[this.song.instrumentFilters[It][Lt.instrument]];Yt=Math.pow(2,-Vs*Cs*4*M/this.samplesPerSecond);var Fs=Math.pow(2,-Vs*Ss*4*M/this.samplesPerSecond);Kt=Math.pow(Fs/Yt,1/ot),Ut=2==this.song.instrumentEffects[It][Lt.instrument]&&Ot-Wt.start<3?0:Math.pow(2,i.effectVibratos[this.song.instrumentEffects[It][Lt.instrument]]/12)-1}0==It?(ht=Gt,lt=Jt,ut=Rt*O,mt=zt*O,pt=Yt*R,ct=Kt,ft=Ut,Ht&&(this._leadSample=0,this._leadPeriodA=0,this._leadPeriodB=0)):1==It?(gt=Gt,dt=Jt,_t=Rt*I,vt=zt*I,bt=Yt*z,wt=Kt,yt=Ut,Ht&&(this._harmonySample=0,this._harmonyPeriodA=0,this._harmonyPeriodB=0)):2==It?(Pt=Gt,Ct=Jt,St=Rt*L,At=zt*L,Mt=Yt*Y,Bt=Kt,kt=Ut,Ht&&(this._bassSample=0,this._bassPeriodA=0,this._bassPeriodB=0)):3==It&&(Nt=Gt/32767,xt=Jt,Vt=Rt*T,Ft=zt*T)}for(var Os=Math.sin(this._effectPeriod),Is=Math.sin(this._effectPeriod-this._effectAngle),Ls=+this._leadSample,Ts=+this._leadPeriodA,Ws=+this._leadPeriodB,Ds=+this._harmonySample,Es=+this._harmonyPeriodA,qs=+this._harmonyPeriodB,js=+this._bassSample,Gs=+this._bassPeriodA,Js=+this._bassPeriodB,Rs=+this._drumSample,zs=+this._drumPeriod,Ys=0|this._delayPos,Ks=+this._delayFeedback0,Us=+this._delayFeedback1,Hs=+this._delayFeedback2,Qs=+this._delayFeedback3,Xs=+this._limit;ot;){var Zs=1+ft*Os,$s=1+yt*Os,te=1+kt*Os,se=1+U*(Os-1),ee=1+H*(Os-1),ie=1+Q*(Os-1),ne=Os;Os=B*Os-Is,Is=ne,Ls+=((W[0|Ts*j]+W[0|Ws*j]*it)*ut*se-Ls)*pt,Ds+=((D[0|Es*G]+D[0|qs*G]*nt)*_t*ee-Ds)*bt,js+=((E[0|Gs*J]+E[0|Js*J]*rt)*St*ie-js)*Mt,Rs+=(q[0|32767*zs]*Vt-Rs)*K,ut+=mt,_t+=vt,St+=At,Vt+=Ft,Ts+=ht*Zs*X,Ws+=ht*Zs*tt,Es+=gt*$s*Z,qs+=gt*$s*st,Gs+=Pt*te*$,Js+=Pt*te*et,zs+=Nt,ht*=lt,gt*=dt,Pt*=Ct,Nt*=xt,pt*=ct,bt*=wt,Mt*=Bt,Ts-=0|Ts,Ws-=0|Ws,Es-=0|Es,qs-=0|qs,Gs-=0|Gs,Js-=0|Js,zs-=0|zs;var re=Ls+Ds+js,ae=x[Ys]+re,oe=x[Ys+3041&16383],he=x[Ys+6426&16383],le=x[Ys+10907&16383],ue=-ae+oe,me=-ae-oe,pe=-he+le,ce=-he-le;Ks+=.5*((ue+pe)*V-Ks),Us+=.5*((me+ce)*V-Us),Hs+=.5*((ue-pe)*V-Hs),Qs+=.5*((me-ce)*V-Qs),x[Ys+3041&16383]=Ks,x[Ys+6426&16383]=Us,x[Ys+10907&16383]=Hs,x[Ys]=Qs,Ys=Ys+1&16383;var fe=ae+oe+he+le+Rs,ge=fe<0?-fe:fe;(Xs-=k)<ge&&(Xs=ge),fe/=.75*Xs+.25,fe*=N,t[r]=fe,r+=1,ot--}this._leadSample=Ls,this._leadPeriodA=Ts,this._leadPeriodB=Ws,this._harmonySample=Ds,this._harmonyPeriodA=Es,this._harmonyPeriodB=qs,this._bassSample=js,this._bassPeriodA=Gs,this._bassPeriodB=Js,this._drumSample=Rs,this._drumPeriod=zs,this._delayPos=Ys,this._delayFeedback0=Ks,this._delayFeedback1=Us,this._delayFeedback2=Hs,this._delayFeedback3=Qs,this._limit=Xs,this._effectPeriod=B*Os-Is>Is?Math.asin(Os):Math.PI-Math.asin(Os),0==this._arpeggioSamples&&(this._arpeggio++,this._arpeggioSamples=M,4==this._arpeggio&&(this._arpeggio=0,++this._part==this.song.parts&&(this._part=0,++this._beat==this.song.beats&&(this._beat=0,this._effectPeriod=0,++this._bar<this.song.loopStart?this.enableIntro||(this._bar=this.song.loopStart):this.enableIntro=!1,this._bar>=this.song.loopStart+this.song.loopLength&&(this.loopCount>0&&this.loopCount--,(this.loopCount>0||!this.enableOutro)&&(this._bar=this.song.loopStart)),this._bar>=this.song.bars&&(this._bar=0,this.enableIntro=!0,F=!0,this.pause()),at()))))}this.stutterPressed&&n(),this._playhead=(((this._arpeggio+1-this._arpeggioSamples/M)/4+this._part)/this.song.parts+this._beat)/this.song.beats+this._bar}else for(var de=0;de<s;de++)t[de]=0},t.prototype._frequencyFromPitch=function(t){return 440*Math.pow(2,(t-69)/12)},t.prototype._volumeConversion=function(t){return Math.pow(t/3,1.5)},t.prototype._getSamplesPerArpeggio=function(){if(null==this.song)return 0;var t=4*(this.song.getBeatsPerMinute()/60*this.song.parts);return Math.floor(this.samplesPerSecond/t)},t}();t.Synth=h}(beepbox||(beepbox={}));